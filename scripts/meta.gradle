import java.nio.charset.StandardCharsets
import java.nio.file.Files
import java.nio.file.StandardOpenOption

void injectForgeTransformers(Project project) {
    var file = initTransformers(project)

    if (file != null) {
        subMod.each { Project mod ->
            helpers.getSubForgeMod(mod).each { Project forgeMod ->
                appendTransformers(file, forgeMod)
            }
        }

        println 'Architectury transformers injected.'
    }
}

void injectFabricTransformers(Project project) {
    var file = initTransformers(project)

    if (file != null) {
        subMod.each { Project mod ->
            helpers.getSubForgeMod(mod).each { Project forgeMod ->
                appendTransformersFabric(file, forgeMod)  // qyl27: Yes, copy from forge mod.
            }
        }

        println 'Architectury transformers injected.'
    }
}

void injectNeoForgeTransformers(Project project) {
    var file = initTransformers(project)

    if (file != null) {
        subMod.each { Project mod ->
            helpers.getSubForgeMod(mod).each { Project forgeMod ->
                appendTransformers(file, forgeMod)  // qyl27: Yes, copy from forge mod.
            }
        }

        println 'Architectury transformers injected.'
    }
}

File initTransformers(Project project) {
    var projectTransformsDir = new File(project.projectDir, '/.gradle/architectury')

    if (projectTransformsDir.exists()) {
        var projectTransformsFile = new File(projectTransformsDir, '.transforms')

        Files.deleteIfExists(projectTransformsFile.toPath())
        Files.createFile(projectTransformsFile.toPath())

        return projectTransformsFile
    }

    return null
}

void appendTransformers(File file, Project project) {
    var projectTransformsFile = new File(project.projectDir, '/.gradle/architectury/.transforms')
    if (!projectTransformsFile.exists()) {
        return
    }

    var text = Files.readString(projectTransformsFile.toPath())
    appendText(file, text)
}

void appendTransformersFabric(File file, Project project) {
    var projectTransformsFile = new File(project.projectDir, '/.gradle/architectury/.transforms')
    if (!projectTransformsFile.exists()) {
        return
    }

    var text = Files.readString(projectTransformsFile.toPath())

    var lines = text.split(';')
    for (def line : lines) {
        if (line.contains('Forge')) {
            continue
        }

        appendText(file, "${line};")
    }

    if (lines.length >= 1) {
        var line = lines[0].split('\\|')
        appendText(file, "${line[0]}|dev.architectury.transformer.transformers.GenerateFakeFabricMod;")
    }
}

void appendText(File file, String string) {
    if (file.exists()) {
        Files.write(file.toPath(), string.getBytes(StandardCharsets.UTF_8), StandardOpenOption.APPEND)
    }
}

ext.metaHelpers = {
    injectForgeTransformers = this.&injectForgeTransformers
    injectFabricTransformers = this.&injectFabricTransformers
    injectNeoForgeTransformers = this.&injectNeoForgeTransformers
}
